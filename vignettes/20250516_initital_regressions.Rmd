---
title: "Initial Understanding Society Regressions"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


This document explores the data produced from an amended version of ukhlsclean which includes more MH and wellbeing variables. 

These data are used to make initial regressions on the relationships between mental health and smoking status.


## load the data
```{r , warning = FALSE , message = FALSE}
library(ggplot2)
library(data.table)
library(tidyverse)

#load the data set 
load("../../ukhlsclean_data/ukhlsclean_data.RData")

```

## % current smokers by wave 
```{r , warning = FALSE , message = FALSE}
# Calculate the percentage of smokers by wave, excluding NA from the denominator
smoker_percentage_by_wave <- data %>%
  group_by(wave_no) %>%
  summarise(
    n_smoker = sum(s_current_smoker == "smoker", na.rm = TRUE),
    n_non_missing = sum(!is.na(s_current_smoker)), # Count of non-missing values
    percentage_smoker = (n_smoker / n_non_missing) * 100,
    .groups = 'drop'
  )


# Create the line plot
ggplot(smoker_percentage_by_wave, aes(x = as.numeric(wave_no), y = percentage_smoker)) +
  geom_line(color = "steelblue", linewidth = 1) +
  geom_point(color = "steelblue", size = 2) +
  #geom_text(aes(label = paste0(round(percentage_smoker, 1), "%")), vjust = -0.5) +
  labs(
    title = "% Current Smokers by Wave",
    x = "Wave Number",
    y = "% Current Smokers"
  ) +
  theme_minimal() + scale_y_continuous(limits = c(0, NA)) +
  scale_x_continuous(breaks = unique(as.numeric(smoker_percentage_by_wave$wave_no))) # Ensure all waves are labeled

```

## % GHQ-12 >=4
```{r , warning = FALSE , message = FALSE}
# Calculate the percentage of smokers by wave, excluding NA from the denominator
smoker_percentage_by_wave <- data %>%
  group_by(wave_no) %>%
  summarise(
    n_smoker = sum(h_ghq_12 >= 4, na.rm = TRUE),
    n_non_missing = sum(!is.na(h_ghq_12)), # Count of non-missing values
    percentage_smoker = (n_smoker / n_non_missing) * 100,
    .groups = 'drop'
  )


# Create the line plot
ggplot(smoker_percentage_by_wave, aes(x = as.numeric(wave_no), y = percentage_smoker)) +
  geom_line(color = "steelblue", linewidth = 1) +
  geom_point(color = "steelblue", size = 2) +
#  geom_text(aes(label = paste0(round(percentage_smoker, 1), "%")), vjust = -0.5) +
  labs(
    title = "% GHQ-12 >=4 by Wave",
    x = "Wave Number",
    y = "% GHQ-12 >=4"
  ) +
  theme_minimal() + scale_y_continuous(limits = c(0, NA)) +
  scale_x_continuous(breaks = unique(as.numeric(smoker_percentage_by_wave$wave_no))) # Ensure all waves are labeled

```


## % GHQ-12 >=4 by current smoker
```{r , warning = FALSE , message = FALSE}
# Calculate the percentage of smokers by wave, excluding NA from the denominator
smoker_percentage_by_wave <- data %>%
  group_by(wave_no, s_current_smoker) %>%
  summarise(
    n_smoker = sum(h_ghq_12 >= 4, na.rm = TRUE),
    n_non_missing = sum(!is.na(h_ghq_12)), # Count of non-missing values
    percentage_smoker = (n_smoker / n_non_missing) * 100,
    .groups = 'drop'
  )

# Create the line plot
ggplot(filter(smoker_percentage_by_wave, !is.na(s_current_smoker)), aes(x = as.numeric(wave_no), y = percentage_smoker, color = s_current_smoker, group = s_current_smoker)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  #geom_text(aes(label = paste0(round(percentage_smoker, 1), "%")), vjust = -0.5) +
  labs(
    title = "% GHQ-12 >=4 by Wave and Current Smoker",
    x = "Wave Number",
    y = "% GHQ-12 >=4"
  ) +
  labs(colour = NULL) +
  theme_minimal() + scale_y_continuous(limits = c(0, NA)) +
  scale_x_continuous(breaks = unique(as.numeric(smoker_percentage_by_wave$wave_no))) # Ensure all waves are labeled

```

## % current smoker for those living in household with children

using Age of youngest child in household: hh_age_yngchl

i.e. of people living in a houseghold wih children (15 or younger), what proportion smoke?

```{r , warning = FALSE , message = FALSE}
# Calculate the percentage of smokers by wave, excluding NA from the denominator
smoker_percentage_by_wave <- data %>%
  filter(!is.na(hh_age_yngchl)&hh_age_yngchl!="no_children") %>%
  group_by(wave_no) %>%
 summarise(
    n_smoker = sum(s_current_smoker == "smoker", na.rm = TRUE),
    n_non_missing = sum(!is.na(s_current_smoker)), # Count of non-missing values
    percentage_smoker = (n_smoker / n_non_missing) * 100,
    .groups = 'drop'
  )


# Create the line plot
ggplot(smoker_percentage_by_wave, aes(x = as.numeric(wave_no), y = percentage_smoker)) +
  geom_line(color = "steelblue", linewidth = 1) +
  geom_point(color = "steelblue", size = 2) +
#  geom_text(aes(label = paste0(round(percentage_smoker, 1), "%")), vjust = -0.5) +
  labs(
    title = "% Current smoker by wave for those in household with children",
    x = "Wave number",
    y = "% Current smoker"
  ) +
  labs(colour = NULL) +
  theme_minimal() + scale_y_continuous(limits = c(0, NA)) +
  scale_x_continuous(breaks = unique(as.numeric(smoker_percentage_by_wave$wave_no))) # Ensure all waves are labeled

```

## logistic regression

make a logistic regression for giving up smoking at t+1 using:

* GHQ-12 >=4: h_ghq_12 >= 4
* Age: d_age_5cat (age split in 5 categories)
* Sex: d_sex
* IMD quintile: d_imd_quintile
* Housing: hh_hometenure

In this version, only those who were smokers at t are included.

```{r , warning = FALSE , message = FALSE}
# Calculate the percentage of smokers by wave, excluding NA from the denominator
log_reg_data <- data |>
  mutate(
    ghq_4plus = (h_ghq_12 >= 4)*1, #make ghq >=4 variable
    non_smoker_tplus1 = 1*(s_current_smoker=="non_smoker")
  ) |> #now make lagged version of variables as using t to predict quiting at t+1
  group_by(pidp) %>%
  arrange(wave_no) %>%
  mutate(smoker_t = lag(s_current_smoker, n = 1, default = NA),
         ghq_4plus_t = lag(ghq_4plus, n = 1, default = NA),
         d_age_5cat_t = lag(d_age_5cat, n = 1, default = NA),
         d_sex_t = lag(d_sex, n = 1, default = NA),
         d_imd_quintile_t = lag(d_imd_quintile, n = 1, default = NA),
         hh_hometenure_t = lag(hh_hometenure, n = 1, default = NA)) %>%
  ungroup() |>
  #now filter to those who were smokers at t
  filter(smoker_t=="smoker") |>
  # npw remove rows with missing values for our selected variables 
  drop_na(non_smoker_tplus1,
          ghq_4plus_t,
          d_age_5cat_t,
          d_sex_t,
          d_imd_quintile_t,
          hh_hometenure_t)


# now for the regression
model1 <- glm(non_smoker_tplus1 ~ 
                as.factor(ghq_4plus_t) +
                as.factor(d_age_5cat_t) +
                as.factor(d_sex_t) +
                as.factor(d_imd_quintile_t) +
                as.factor(hh_hometenure_t),
              data = log_reg_data, family = "binomial")

summary(model1)
```

Looking at the log odds, Alan/Damon said:

I think the coefficients are saying that ...
people are less likely to be a non smoker at t+1 if at time t they are GHQ4+, older age, living in more deprived area, male
BUT i think that is because they are already more likely to be a smoker at time t if the have those same characteristics

SO I think we need to adjust the regression code as follows:
either:

* (A) account for being a smoker at time t by including smoking status at time t on the right hand side
or 
* (B) make the left hand side Y variable into something more like probability of quitting given you are a smoker,
so something like the left hand side variable being 
  + =1 IF person changes from being a smoker at t to a non-smoker at t+1
and 
  + =0 IF (person has same smoking status at time t+1 and time t) OR (person is a non-smoker at t but becomes a smoker at t+1)


## (A) account for being a smoker at time t by including smoking status at time t on the right hand side


In this version non-smokers at time t are included, and the regression is still predicting being a non-smoker at time t+1

```{r , warning = FALSE , message = FALSE}
log_reg_data <- data |>
  mutate(
    ghq_4plus = (h_ghq_12 >= 4)*1, #make ghq >=4 variable
    non_smoker_tplus1 = 1*(s_current_smoker=="non_smoker")
  ) |> #now make lagged version of variables as using t to predict quiting at t+1
  group_by(pidp) %>%
  arrange(wave_no) %>%
  mutate(smoker_t = lag(s_current_smoker, n = 1, default = NA),
         ghq_4plus_t = lag(ghq_4plus, n = 1, default = NA),
         d_age_5cat_t = lag(d_age_5cat, n = 1, default = NA),
         d_sex_t = lag(d_sex, n = 1, default = NA),
         d_imd_quintile_t = lag(d_imd_quintile, n = 1, default = NA),
         hh_hometenure_t = lag(hh_hometenure, n = 1, default = NA)) %>%
  ungroup() |>
    # now remove rows with missing values for our selected variables 
  drop_na(non_smoker_tplus1,
          ghq_4plus_t,
          d_age_5cat_t,
          d_sex_t,
          d_imd_quintile_t,
          hh_hometenure_t,
          smoker_t)


# now for the regression
model_a <- glm(non_smoker_tplus1 ~ 
                as.factor(smoker_t) + #added smoking at t 
                as.factor(ghq_4plus_t) +
                as.factor(d_age_5cat_t) +
                as.factor(d_sex_t) +
                as.factor(d_imd_quintile_t) +
                as.factor(hh_hometenure_t),
              data = log_reg_data, family = "binomial")

summary(model_a)
```


## (B) make the left hand side Y variable into something more like probability of quitting given you are a smoker,

In this version, non-smokers at time t are included and the regression is predicting quitting at time t+1, so:

* quit = 1 if smoker at t and non-smoker t+1
* quit = 0 if non-smoker at t or smoker at t+1

```{r , warning = FALSE , message = FALSE}
log_reg_data <- data |>
  mutate(
    ghq_4plus = (h_ghq_12 >= 4)*1, #make ghq >=4 variable
    non_smoker_tplus1 = 1*(s_current_smoker=="non_smoker")
  ) |> #now make lagged version of variables as using t to predict quiting at t+1
  group_by(pidp) %>%
  arrange(wave_no) %>%
  mutate(smoker_t = lag(s_current_smoker, n = 1, default = NA),
         ghq_4plus_t = lag(ghq_4plus, n = 1, default = NA),
         d_age_5cat_t = lag(d_age_5cat, n = 1, default = NA),
         d_sex_t = lag(d_sex, n = 1, default = NA),
         d_imd_quintile_t = lag(d_imd_quintile, n = 1, default = NA),
         hh_hometenure_t = lag(hh_hometenure, n = 1, default = NA),
         quit_tplus1 = case_when(smoker_t =="smoker" & non_smoker_tplus1 == 1 ~ 1,
                                smoker_t =="non_smoker"| non_smoker_tplus1 == 0 ~ 0 )
         ) %>%
  ungroup() |>
    # now remove rows with missing values for our selected variables 
  drop_na(non_smoker_tplus1,
          ghq_4plus_t,
          d_age_5cat_t,
          d_sex_t,
          d_imd_quintile_t,
          hh_hometenure_t,
          smoker_t)

# now for the regression
model_b <- glm(quit_tplus1 ~ 
                as.factor(smoker_t) + #added smoking at t 
                as.factor(ghq_4plus_t) +
                as.factor(d_age_5cat_t) +
                as.factor(d_sex_t) +
                as.factor(d_imd_quintile_t) +
                as.factor(hh_hometenure_t),
              data = log_reg_data, family = "binomial")

summary(model_b)

log_reg_data |>
  group_by(smoker_t, s_current_smoker, non_smoker_tplus1, quit_tplus1)|>
  summarise(n = n())
  
```
